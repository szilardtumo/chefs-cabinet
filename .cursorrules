# Chef's Cabinet - AI Coding Rules

## Tech Stack

### Core

- **React 19** + **TanStack Start v1.134.6** (SSR framework)
- **TanStack Router v1.134.15** (file-based routing)
- **Vite v7.2.2** (port 3000)
- **TypeScript** (strict mode)

### Backend

- **Convex v1.28.2** (serverless backend + realtime DB)
  - Auto-generates types in `convex/_generated/`
  - File storage for images
- **convex-helpers v0.1.104** (custom auth builders)

### Auth & Data

- **Clerk @clerk/tanstack-react-start v0.26.9** (auth)
  - Uses `ConvexProviderWithClerk`
  - Protected routes via `_authed.tsx` layout
- **@tanstack/react-query v5.90.7** + **@convex-dev/react-query alpha.11**
  - Use `useConvexQuery` for queries
  - Use `useMutation` from `convex/react` for mutations

### UI

- **Tailwind CSS v4.1.17** (utility-first, oklch color space)
- **ShadCN UI** (New York style) - components in `src/components/ui/`
- **Radix UI** (primitives)
- **Lucide React v0.553.0** (icons)
- **class-variance-authority v0.7.1** (CVA)

### Forms & Validation

- **@tanstack/react-form v1.23.8** (form state)
- **Zod v4.1.12** (validation)

### Other

- **@dnd-kit** (drag & drop)
- **sonner v2.0.7** (toasts)
- **emoji-picker-react v4.15.0**
- **Vercel AI SDK v5.0.89** + **@ai-sdk/openai v2.0.64**

## Path Aliases

```typescript
@/*        -> ./src/*
@convex/*  -> ./convex/*
```

## Project Structure

```
convex/
  _generated/        # Auto-generated (DON'T EDIT)
  schema.ts          # DB schema
  helpers.ts         # authenticatedQuery/Mutation
  *.ts               # Backend functions
src/
  routes/
    __root.tsx       # Root with providers
    _authed.tsx      # Auth layout
    _authed/         # Protected pages
  components/
    app-layout.tsx   # Sidebar layout
    ui/              # ShadCN components
  lib/utils.ts       # cn() helper
  styles/app.css     # Theme variables
```

## Database Schema

**categories**: `userId`, `name`, `description`, `emoji`, `color`, `order`

- Indexes: `by_user`, `by_user_and_order`

**ingredients**: `userId`, `name`, `categoryId`, `defaultUnit`, `notes`, `emoji`

- Indexes: `by_user`, `by_category`, `by_user_and_name`

**recipes**: `userId`, `title`, `description`, `image` (storage ID), `cookingTime`, `prepTime`, `servings`, `instructions` (array), `tags` (array), `history` (array, optional)

- Index: `by_user`

**recipeIngredients**: `recipeId`, `ingredientId`, `quantity`, `unit`, `notes`, `order`

- Indexes: `by_recipe`, `by_ingredient`, `by_recipe_and_order`

**shoppingLists**: `userId`, `name`, `status` (active/completed/archived), `createdAt`, `completedAt`

- Indexes: `by_user`, `by_user_and_status`

**shoppingListItems**: `shoppingListId`, `ingredientId`, `recipeId` (optional), `checked`, `notes`, `order`

- Indexes: `by_list`, `by_list_and_order`

## Convex Patterns

### Authentication

```typescript
import { authenticatedQuery, authenticatedMutation } from "./helpers";

export const myQuery = authenticatedQuery({
  args: { id: v.id("recipes") },
  handler: async (ctx, args) => {
    // ctx.userId automatically available
  },
});
```

### Validation

```typescript
import { v } from "convex/values";

args: {
  id: v.id("recipes"),
  name: v.string(),
  optional: v.optional(v.string()),
  array: v.array(v.string()),
}
```

### Queries

```typescript
// Query with index
const items = await ctx.db
  .query("recipes")
  .withIndex("by_user", (q) => q.eq("userId", ctx.userId))
  .order("desc")
  .collect();

// Get by ID
const item = await ctx.db.get(itemId);

// Insert
const id = await ctx.db.insert("recipes", { ... });

// Update
await ctx.db.patch(id, { field: value });

// Delete
await ctx.db.delete(id);
```

### File Storage

```typescript
// Get URL (storage IDs are NOT URLs)
const url = await ctx.storage.getUrl(storageId);

// Delete
await ctx.storage.delete(storageId);
```

## Frontend Patterns

### Routes

```typescript
import { createFileRoute } from "@tanstack/react-router";

export const Route = createFileRoute("/_authed/recipes/")({
  component: RecipesComponent,
});

function RecipesComponent() {
  return <AppLayout>{/* content */}</AppLayout>;
}
```

### Data Fetching

```typescript
import { useConvexQuery } from "@convex-dev/react-query";
import { useMutation } from "convex/react";
import { api } from "@convex/_generated/api";

// Queries
const data = useConvexQuery(api.recipes.getAll, {});

// Mutations
const createRecipe = useMutation(api.recipes.create);
await createRecipe({ title: "..." });
```

### Navigation

```typescript
import { Link, useNavigate } from "@tanstack/react-router";

<Link to="/recipes/$recipeId" params={{ recipeId }}>
  View
</Link>;

const navigate = useNavigate();
navigate({ to: "/recipes" });
```

### Styling

```typescript
import { cn } from "@/lib/utils";

<div className={cn("base", isActive && "active", className)} />;
```

### ShadCN Components

```typescript
import { Button } from "@/components/ui/button";
import { Dialog, DialogContent, DialogHeader } from "@/components/ui/dialog";

<Button variant="destructive" size="sm">Delete</Button>
<Button asChild><Link to="/">Link</Link></Button>
```

### Toasts

```typescript
import { toast } from "sonner";

toast.success("Done!");
toast.error("Failed");
```

### Types

```typescript
import { Id } from "@convex/_generated/dataModel";
import { api } from "@convex/_generated/api";

const recipeId: Id<"recipes"> = "...";
```

## Critical Rules

1. **Use `authenticatedQuery`/`authenticatedMutation`** from helpers, NOT raw `query`/`mutation`
2. **Use `Id<"tableName">`** for IDs, not `string`
3. **Use `useMutation` from `convex/react`** for mutations (not React Query)
4. **Use `useConvexQuery`** from `@convex-dev/react-query` for queries
5. **Storage IDs are not URLs** - always use `ctx.storage.getUrl()`
6. **Don't edit `convex/_generated/`** - auto-generated
7. **Route files must export `Route`** created with `createFileRoute()`
8. **File-based routing**: `$id` = param, `index` = base, `_layout` = layout
9. **Import ShadCN from `@/components/ui/`**, not Radix directly
10. **All data is user-scoped** - include userId in queries

## AI Actions Pattern

```typescript
// AI actions return { success: boolean, text?: string, error?: string }
const result = await generateRecipeDescription({ ... });
if (result.success) {
  // Use result.text
} else {
  // Show result.error
}
```

## Naming Conventions

- Components: PascalCase
- Files: kebab-case (routes), PascalCase (components)
- Functions: camelCase
- Types: PascalCase
